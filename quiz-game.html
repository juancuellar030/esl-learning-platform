<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="assets/graduation-cap-icon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Quiz Game - ESL Learning Platform</title>
    <meta name="description"
        content="Real-time multiplayer quiz game for ESL classrooms. Host or join a live quiz session with your class.">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/quiz-game.css">
    <link rel="stylesheet" href="css/google-drive.css">
    <!-- Firebase CDN (compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
</head>

<body>
    <div class="qg-app" id="quiz-app">

        <!-- ===== SESSION CODE BADGE ===== -->
        <div class="qg-session-badge" id="session-code-badge" style="display:none;">
            <i class="fa-solid fa-hashtag"></i>
            <span id="session-badge-code">------</span>
        </div>

        <!-- ===== BACKGROUND ANIMATION LAYER ===== -->
        <canvas id="qg-bg-canvas" aria-hidden="true"></canvas>

        <!-- ===== SCREEN: ROLE SELECT ===== -->
        <div class="qg-screen active" id="screen-role">
            <div class="qg-role-container">
                <div class="qg-logo-area">
                    <i class="fa-solid fa-bolt qg-logo-icon"></i>
                    <h1 class="qg-title">Live Quiz</h1>
                    <p class="qg-subtitle">Real-time multiplayer classroom quiz</p>
                </div>
                <div class="qg-role-cards">
                    <button class="qg-role-card qg-role-host" id="btn-role-host">
                        <div class="qg-role-icon"><i class="fa-solid fa-chalkboard-user"></i></div>
                        <h2>Host a Game</h2>
                        <p>Create a quiz and invite your students</p>
                    </button>
                    <button class="qg-role-card qg-role-join" id="btn-role-join">
                        <div class="qg-role-icon"><i class="fa-solid fa-gamepad"></i></div>
                        <h2>Join a Game</h2>
                        <p>Enter a game code to play</p>
                    </button>
                </div>
                <a href="tools.html" class="qg-back-link"><i class="fa-solid fa-arrow-left"></i> Back to Tools</a>
            </div>
        </div>

        <!-- ===== SCREEN: HOST SETUP ===== -->
        <div class="qg-screen" id="screen-setup">
            <div class="qg-setup-panel">
                <h2><i class="fa-solid fa-wand-magic-sparkles"></i> Create Your Quiz</h2>

                <!-- Source Mode Toggle -->
                <div class="qg-setup-section">
                    <label class="qg-setup-label">Quiz Source</label>
                    <div class="qg-source-toggle">
                        <button class="qg-source-btn active" id="src-vocab" data-source="vocab"><i
                                class="fa-solid fa-book"></i> Vocabulary Bank</button>
                        <button class="qg-source-btn" id="src-custom" data-source="custom"><i
                                class="fa-solid fa-pen-ruler"></i> Custom Quiz</button>
                    </div>
                </div>

                <!-- Game Mode Toggle -->
                <div class="qg-setup-section">
                    <label class="qg-setup-label">Game Mode</label>
                    <div class="qg-mode-toggle">
                        <button class="qg-mode-btn active" data-mode="automatic">
                            <i class="fa-solid fa-robot"></i>
                            <span class="qg-mode-label">Automatic</span>
                            <span class="qg-mode-desc">Auto-advance when all answer</span>
                        </button>
                        <button class="qg-mode-btn" data-mode="student-paced">
                            <i class="fa-solid fa-user-graduate"></i>
                            <span class="qg-mode-label">Student-Paced</span>
                            <span class="qg-mode-desc">Each student goes at own speed</span>
                        </button>
                        <button class="qg-mode-btn" data-mode="teacher-paced">
                            <i class="fa-solid fa-chalkboard-user"></i>
                            <span class="qg-mode-label">Teacher-Paced</span>
                            <span class="qg-mode-desc">Teacher controls the flow</span>
                        </button>
                    </div>
                </div>

                <!-- VOCAB MODE -->
                <div id="vocab-mode">
                    <div class="qg-setup-section">
                        <label class="qg-setup-label">Vocabulary Categories</label>
                        <div class="qg-category-chips" id="category-chips">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <div class="qg-setup-section">
                        <label class="qg-setup-label">Difficulty Level</label>
                        <div class="qg-level-btns">
                            <button class="qg-level-btn active" data-level="all">All</button>
                            <button class="qg-level-btn" data-level="beginner">Beginner</button>
                            <button class="qg-level-btn" data-level="intermediate">Intermediate</button>
                        </div>
                    </div>
                </div>

                <!-- CUSTOM MODE (hidden by default) -->
                <div id="custom-mode" class="qg-hidden">
                    <div class="qg-setup-section">
                        <label class="qg-setup-label">Your Questions</label>
                        <p class="qg-custom-hint">Enter words/concepts and their clues. Optional: attach images or
                            audio.</p>
                        <div class="qg-custom-list" id="custom-list">
                            <!-- Rows populated by JS -->
                        </div>
                        <button class="qg-btn qg-btn-add-row" id="btn-add-row">
                            <i class="fa-solid fa-plus"></i> Add Question
                        </button>
                    </div>
                </div>



                <div class="qg-setup-row">
                    <div class="qg-setup-section">
                        <label class="qg-setup-label">Questions</label>
                        <div class="qg-stepper">
                            <button class="qg-step-btn" id="q-minus"><i class="fa-solid fa-minus"></i></button>
                            <span class="qg-step-value" id="q-count">10</span>
                            <button class="qg-step-btn" id="q-plus"><i class="fa-solid fa-plus"></i></button>
                        </div>
                    </div>
                    <div class="qg-setup-section">
                        <label class="qg-setup-label">Timer (seconds)</label>
                        <div class="qg-stepper">
                            <button class="qg-step-btn" id="t-minus"><i class="fa-solid fa-minus"></i></button>
                            <span class="qg-step-value" id="t-count">15</span>
                            <button class="qg-step-btn" id="t-plus"><i class="fa-solid fa-plus"></i></button>
                        </div>
                    </div>
                </div>

                <div class="qg-setup-section">
                    <label class="qg-setup-label">Options</label>
                    <div class="qg-options-grid">
                        <label class="qg-toggle-option">
                            <input type="checkbox" id="opt-shuffle" checked>
                            <span>Shuffle Questions</span>
                        </label>
                        <label class="qg-toggle-option">
                            <input type="checkbox" id="opt-show-answer" checked>
                            <span>Show Correct Answer</span>
                        </label>
                        <label class="qg-toggle-option">
                            <input type="checkbox" id="opt-streaks" checked>
                            <span>Streak Bonuses</span>
                        </label>
                        <label class="qg-toggle-option">
                            <input type="checkbox" id="opt-sound" checked>
                            <span>Sound Effects</span>
                        </label>
                    </div>
                </div>

                <div class="qg-setup-actions">
                    <button class="qg-btn qg-btn-ghost" id="btn-setup-back"><i class="fa-solid fa-arrow-left"></i>
                        Back</button>
                    <button class="qg-btn qg-btn-primary qg-btn-lg" id="btn-create-game"><i
                            class="fa-solid fa-play"></i> Create Game</button>
                </div>
            </div>
        </div>

        <!-- ===== SCREEN: LOBBY ===== -->
        <div class="qg-screen" id="screen-lobby">
            <div class="qg-lobby-container">
                <div class="qg-lobby-header">
                    <h2>Join at <span class="qg-lobby-url">this page</span></h2>
                    <div class="qg-game-code" id="game-code-display">------</div>
                    <div class="qg-lobby-player-count">
                        <i class="fa-solid fa-users"></i>
                        <span id="player-count">0</span> players joined
                    </div>
                </div>
                <div class="qg-lobby-players" id="lobby-players">
                    <!-- Player cards populated by JS -->
                </div>
                <div class="qg-lobby-actions">
                    <button class="qg-btn qg-btn-ghost" id="btn-lobby-cancel"><i class="fa-solid fa-xmark"></i>
                        Cancel</button>
                    <button class="qg-btn qg-btn-accent qg-btn-lg qg-pulse" id="btn-start-game" disabled>
                        <i class="fa-solid fa-rocket"></i> Start Game
                    </button>
                </div>
            </div>
        </div>

        <!-- ===== SCREEN: JOIN (Step 1: Code & Name) ===== -->
        <div class="qg-screen" id="screen-join">
            <div class="qg-join-panel">
                <h2><i class="fa-solid fa-right-to-bracket"></i> Join Game</h2>
                <div class="qg-join-field">
                    <label>Game Code</label>
                    <input type="text" id="join-code" maxlength="6" placeholder="ABCD12" autocomplete="off"
                        spellcheck="false">
                </div>
                <div class="qg-join-field">
                    <label>Your Name</label>
                    <input type="text" id="join-name" maxlength="20" placeholder="Enter your name" autocomplete="off">
                </div>
                <div class="qg-join-actions">
                    <button class="qg-btn qg-btn-ghost" id="btn-join-back"><i class="fa-solid fa-arrow-left"></i>
                        Back</button>
                    <button class="qg-btn qg-btn-accent qg-btn-lg" id="btn-join-next"><i
                            class="fa-solid fa-arrow-right"></i>
                        Next</button>
                </div>
                <p class="qg-join-error" id="join-error"></p>
            </div>
        </div>

        <!-- ===== SCREEN: AVATAR SELECTION (Step 2) ===== -->
        <div class="qg-screen" id="screen-avatar">
            <div class="qg-avatar-panel">
                <h2><i class="fa-solid fa-paw"></i> Choose Your Avatar</h2>
                <p class="qg-avatar-subtitle">Pick an animal to represent you in the game!</p>
                <div class="qg-avatar-grid-select" id="avatar-grid-select">
                    <!-- Populated by JS -->
                </div>
                <div class="qg-join-actions">
                    <button class="qg-btn qg-btn-ghost" id="btn-avatar-back"><i class="fa-solid fa-arrow-left"></i>
                        Back</button>
                    <button class="qg-btn qg-btn-accent qg-btn-lg" id="btn-join-game"><i class="fa-solid fa-play"></i>
                        Join!</button>
                </div>
            </div>
        </div>

        <!-- ===== SCREEN: WAITING (Student) ===== -->
        <div class="qg-screen" id="screen-waiting">
            <div class="qg-waiting-container">
                <div class="qg-waiting-avatar" id="waiting-avatar"></div>
                <h2>You're in the lobby!</h2>
                <p class="qg-waiting-name" id="waiting-name"></p>
                <button type="button" class="qg-change-avatar-btn" id="btn-change-avatar">
                    <i class="fa-solid fa-shuffle"></i> Change Avatar
                </button>
                <button type="button" class="qg-change-avatar-btn" id="btn-change-theme" style="margin-top: 10px;">
                    <i class="fa-solid fa-palette"></i> Themes
                </button>
                <p class="qg-waiting-dots">Waiting for the host to start<span
                        class="qg-dots"><span>.</span><span>.</span><span>.</span></span></p>
            </div>
        </div>

        <!-- ===== SCREEN: GAME (Shared ‚Äî content differs by role) ===== -->
        <div class="qg-screen" id="screen-game">
            <!-- Teacher view: question + leaderboard -->
            <div class="qg-teacher-view" id="teacher-view">
                <div class="qg-tv-header">
                    <div class="qg-tv-progress">
                        <span id="tv-q-num">1</span> / <span id="tv-q-total">10</span>
                    </div>
                    <div class="qg-tv-timer-bar">
                        <div class="qg-tv-timer-fill" id="tv-timer-fill"></div>
                    </div>
                    <div class="qg-tv-answered"><i class="fa-solid fa-check-circle"></i> <span id="tv-answered">0</span>
                        / <span id="tv-total-players">0</span></div>

                    <button class="qg-btn qg-btn-ghost qg-btn-end-global" id="btn-global-end-game"
                        aria-label="End game immediately">
                        <i class="fa-solid fa-power-off"></i> End Game
                    </button>
                </div>
                <div class="qg-tv-question" id="tv-question">Loading question...</div>
                <div class="qg-tv-answers" id="tv-answers">
                    <!-- 4 answer bars with distribution -->
                </div>
                <div class="qg-tv-leaderboard" id="tv-leaderboard">
                    <h3><i class="fa-solid fa-trophy"></i> Leaderboard</h3>
                    <div class="qg-tv-lb-list" id="tv-lb-list"></div>
                </div>
                <!-- Teacher-Paced: Next Question button -->
                <div class="qg-tv-teacher-controls qg-hidden" id="tv-teacher-controls">
                    <button class="qg-btn qg-btn-accent qg-btn-lg qg-pulse" id="btn-next-question">
                        <i class="fa-solid fa-forward"></i> Next Question
                    </button>
                </div>
            </div>

            <!-- Student view: question + answer buttons -->
            <div class="qg-student-view" id="student-view">
                <div class="qg-sv-header">
                    <div class="qg-sv-score">
                        <span class="qg-sv-score-label">Score</span>
                        <span class="qg-sv-score-value" id="sv-score">0</span>
                    </div>
                    <div class="qg-sv-progress" id="sv-progress">1 / 10</div>
                    <div class="qg-sv-streak" id="sv-streak"></div>
                </div>
                <div class="qg-sv-timer">
                    <div class="qg-sv-timer-fill" id="sv-timer-fill"></div>
                </div>
                <div class="qg-sv-question" id="sv-question">Loading question...</div>
                <div class="qg-sv-answers" id="sv-answers">
                    <button class="qg-answer-btn qg-ans-0" data-index="0"></button>
                    <button class="qg-answer-btn qg-ans-1" data-index="1"></button>
                    <button class="qg-answer-btn qg-ans-2" data-index="2"></button>
                    <button class="qg-answer-btn qg-ans-3" data-index="3"></button>
                </div>
            </div>
        </div>

        <!-- ===== SCREEN: RESULTS ===== -->
        <div class="qg-screen" id="screen-results">
            <div class="qg-results-container">
                <h2 class="qg-results-title">üèÜ Game Over!</h2>
                <div class="qg-podium" id="podium">
                    <div class="qg-podium-place qg-place-2" id="podium-2">
                        <div class="qg-podium-avatar">ü•à</div>
                        <div class="qg-podium-name"></div>
                        <div class="qg-podium-score"></div>
                        <div class="qg-podium-bar"></div>
                    </div>
                    <div class="qg-podium-place qg-place-1" id="podium-1">
                        <div class="qg-podium-avatar">ü•á</div>
                        <div class="qg-podium-name"></div>
                        <div class="qg-podium-score"></div>
                        <div class="qg-podium-bar"></div>
                    </div>
                    <div class="qg-podium-place qg-place-3" id="podium-3">
                        <div class="qg-podium-avatar">ü•â</div>
                        <div class="qg-podium-name"></div>
                        <div class="qg-podium-score"></div>
                        <div class="qg-podium-bar"></div>
                    </div>
                </div>
                <div class="qg-results-table-wrap">
                    <table class="qg-results-table" id="results-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Name</th>
                                <th>Score</th>
                                <th>Streak</th>
                            </tr>
                        </thead>
                        <tbody id="results-tbody"></tbody>
                    </table>
                </div>
                <div class="qg-results-actions">
                    <button class="qg-btn qg-btn-accent qg-btn-lg" id="btn-play-again"><i
                            class="fa-solid fa-rotate-right"></i> Play Again</button>
                    <button class="qg-btn qg-btn-ghost" id="btn-new-game"><i class="fa-solid fa-house"></i> New
                        Game</button>
                </div>

                <!-- Extra Actions: Download & Drive -->
                <div class="qg-results-extra-actions">
                    <button class="qg-extra-btn" id="btn-download-results" title="Download Scoreboard (CSV)">
                        <i class="fa-solid fa-file-csv"></i> Download CSV
                    </button>
                    <button class="qg-extra-btn" id="btn-save-drive" title="Save to Google Drive">
                        <i class="fa-brands fa-google-drive"></i> Save to Drive
                    </button>
                </div>
            </div>
        </div>

        <!-- ===== SCREEN: BOOTED / DISCONNECTED ===== -->
        <div class="qg-screen" id="screen-booted" style="align-items: center; justify-content: center; padding: 20px;">
            <div class="qg-join-panel"
                style="text-align: center; max-width: 500px; padding: 40px 30px; margin: 0 auto;">
                <i class="fa-solid fa-user-slash" style="font-size: 4rem; color: #ff6b6b; margin-bottom: 20px;"></i>
                <h2 id="booted-title" style="margin-bottom: 10px; display: flex; justify-content: center;">Oops!</h2>
                <p id="booted-message" style="margin-bottom: 25px; font-size: 1.1rem;">You have been
                    removed from the lobby by the host.</p>
                <button class="qg-btn qg-btn-primary" id="btn-rejoin-game"
                    style="width: 100%; justify-content: center;">
                    <i class="fa-solid fa-arrow-rotate-left"></i> Rejoin Game
                </button>
            </div>
        </div>

        <!-- ===== OVERLAY: Change Avatar Modal ===== -->
        <div class="qg-overlay" id="overlay-avatar-modal"
            style="align-items: center; justify-content: center; padding: 20px;">
            <div class="qg-join-panel"
                style="position: relative; max-width: 800px; padding: 30px; margin: 0 auto; text-align: center;">
                <button class="qg-modal-close" id="btn-close-avatar-modal"
                    style="position: absolute; top: 15px; right: 20px; border: none; background: transparent; font-size: 1.8rem; color: #888; cursor: pointer; transition: color 0.2s;">
                    <i class="fa-solid fa-xmark"></i>
                </button>
                <h2 style="margin-bottom: 25px; color: var(--indigo-velvet); justify-content: center;">
                    <i class="fa-solid fa-paw"></i> Select Your Avatar
                </h2>
                <div class="qg-avatar-grid-waiting" id="avatar-grid-waiting"
                    style="display: grid; margin-bottom: 30px;">
                    <!-- Populated by JS -->
                </div>
                <div class="qg-join-actions" style="margin-top: 0; display: flex; gap: 15px;">
                    <button class="qg-btn qg-btn-ghost qg-btn-lg" id="btn-random-avatar"
                        style="flex: 1; border: 2px solid var(--indigo-velvet); color: var(--indigo-velvet); justify-content: center;">
                        <i class="fa-solid fa-dice"></i> Random Picker
                    </button>
                    <button class="qg-btn qg-btn-primary qg-btn-lg" id="btn-save-avatar"
                        style="flex: 1; justify-content: center;">
                        <i class="fa-solid fa-check"></i> Select
                    </button>
                </div>
            </div>
        </div>

        <!-- ===== OVERLAY: Change Theme Modal ===== -->
        <div class="qg-overlay" id="overlay-theme-modal"
            style="align-items: center; justify-content: center; padding: 20px;">
            <div class="qg-join-panel"
                style="position: relative; max-width: 500px; padding: 30px; margin: 0 auto; text-align: center;">
                <button class="qg-modal-close" id="btn-close-theme-modal"
                    style="position: absolute; top: 15px; right: 20px; border: none; background: transparent; font-size: 1.8rem; color: #888; cursor: pointer; transition: color 0.2s;">
                    <i class="fa-solid fa-xmark"></i>
                </button>
                <h2 style="margin-bottom: 25px; color: var(--indigo-velvet); justify-content: center;">
                    <i class="fa-solid fa-palette"></i> Select Theme
                </h2>
                <div class="qg-theme-modal-content"
                    style="display: flex; flex-direction: column; gap: 20px; align-items: center;">
                    <div class="qg-theme-swatches"
                        style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; width: 100%;">
                        <button class="qg-theme-swatch active" data-theme="default" title="Default"
                            style="background: linear-gradient(135deg,#3d348b,#7678ed);">Default</button>
                        <button class="qg-theme-swatch" data-theme="neon" title="Neon"
                            style="background: linear-gradient(135deg,#0a0a1a,#00f5ff);">Neon</button>
                        <button class="qg-theme-swatch" data-theme="forest" title="Forest"
                            style="background: linear-gradient(135deg,#1a3d2b,#52b788);">Forest</button>
                        <button class="qg-theme-swatch" data-theme="winter" title="Winter"
                            style="background: linear-gradient(135deg,#a8d8ea,#48cae4);">Winter</button>
                        <button class="qg-theme-swatch" data-theme="candy" title="Candy"
                            style="background: linear-gradient(135deg,#f72585,#c77dff);">Candy</button>
                        <button class="qg-theme-swatch" data-theme="pastel" title="Pastel"
                            style="background: linear-gradient(135deg,#ffd6e7,#c77dff);">Pastel</button>
                        <button class="qg-theme-swatch" data-theme="ocean" title="Ocean"
                            style="background: linear-gradient(135deg,#023e8a,#90e0ef);">Ocean</button>
                    </div>

                    <div style="width: 100%; height: 1px; background: rgba(0,0,0,0.05); margin: 5px 0;"></div>

                    <div style="display: flex; align-items: center; justify-content: center; width: 100%;">
                        <button class="qg-dark-toggle" id="qg-lobby-dark-toggle" title="Toggle Dark Mode"
                            style="background: #333; color: #f1c40f; border: none; width: 50px; height: 50px; border-radius: 50%; font-size: 1.5rem; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                            <i class="fa-solid fa-moon" id="qg-dark-icon"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===== OVERLAY: Countdown ===== -->
        <div class="qg-overlay" id="overlay-countdown">
            <div class="qg-countdown-number" id="countdown-number">3</div>
        </div>

        <!-- ===== OVERLAY: Feedback ===== -->
        <div class="qg-overlay qg-feedback" id="overlay-feedback">
            <div class="qg-feedback-icon" id="feedback-icon"></div>
            <div class="qg-feedback-text" id="feedback-text"></div>
            <div class="qg-feedback-points" id="feedback-points"></div>
        </div>

        <!-- ===== Confetti Canvas ===== -->
        <canvas id="confetti-canvas"></canvas>

    </div>

    <script src="js/vocabulary-data.js"></script>
    <script src="js/firebase-service.js"></script>
    <script src="js/darkmode.js"></script>
    <script src="js/google-drive-service.js"></script>
    <script src="js/quiz-game.js"></script>
</body>

</html>